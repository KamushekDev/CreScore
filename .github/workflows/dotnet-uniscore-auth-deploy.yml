name: dotnet - Unicsore.Auth - Deploy
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to be deployed'
        required: true
        type: choice
        options:
        - production
        - staging
jobs:
  deploy-prep:
    uses: ./.github/workflows/dotnet-uniscore-auth.yaml
    secrets: inherit
  
  deploy:
    needs: deploy-prep
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: OpenVpn setup
        uses: ./.github/actions/deploy/openVpn-setup
          with: 
            openVpnConfig: ${{ secrets.VPN_CONFIG }}
            openVpnUserName: ${{ secrets.VPN_USERNAME }}
            openVpnUserPassword: ${{ secrets.VPN_PASSWORD }}
      - name: Kubectl setup
        uses: Azure/setup-kubectl@v3
      - name: Setup kubectl config
        uses: ./.github/actions/deploy/kubectl-setup
          with: 
            kubeConfig: ${{ secrets.KUBE_CONFIG }}
      - name: Deploy service
        uses: ./.github/actions/deploy/deploy-resources
          with: 
            environment: ${{ inputs.environment }}
            resourcePath: "services/${{ needs.deploy-prep.outputs.project_name }}"
      - name: Restart service
        run: |
          kubectl rollout restart -f ./k8s/base/services/${{ needs.deploy-prep.outputs.project_name }}/deployment.yaml
    
